<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Resumo de Códigos</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding-top: 70px; 
      padding-bottom: 90px;
      background-color: #f4f4f9;
      color: #333;
    }
    
    header {
      background-color: #0C296C;
      color: white;
      height: 70px;
      width: 100%;
      position: fixed;
      top: 0;
      left: 0;
      display: flex;
      align-items: center;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      z-index: 1000;
    }
    header > div {
      display: flex;
      width: 100%;
      justify-content: space-between;
      align-items: center;
      padding: 0 20px;
    }
    .header-logo { height: 60px; object-fit: contain; }
    .header-title { flex-grow: 1; text-align: center; }
    .header-title h2 { margin: 0; font-size: 1.5em; }

    .container-botoes {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background-color: #ffffff;
      padding: 15px 0;
      text-align: center;
      box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
      z-index: 1000;
    }
    
    .container-principal {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      flex-wrap: wrap;
      gap: 30px;
      padding: 20px 20px 0 20px;
    }

    .tabela-container {
      flex: 1;
      min-width: 400px;
      max-width: 600px;
    }

    .container-botoes button { margin: 0 5px; }

    /* CORREÇÃO: Readiciona a regra para esconder o input de arquivo original */
    input[type="file"] { display: none; }
    
    table {
      width: 100%;
      margin: 10px auto;
      border-collapse: collapse;
      background: white;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    th, td { padding: 12px; border: 1px solid #ddd; text-align: center; }
    thead th { background: #343a40; color: white; }
    thead tr:first-child th { background-color: #007bff; font-size: 1.1em; }
    tr:nth-child(even) { background: #f9f9f9; }
    tfoot td { font-weight: bold; background-color: #e9ecef; }

    #totalGeralContainer {
        text-align: center;
        margin-top: 40px;
        font-size: 1.2em;
        padding-bottom: 20px;
    }
    
    #aviso-carregamento-texto {
        text-transform: uppercase;
        font-size: 1.25rem;
        font-weight: bold;
        text-align: center;
    }
  </style>
</head>
<body>

  <header>
    <div>
      <a href="#"><img src="imagem/baixados.png" alt="Logo" class="header-logo"></a>
      <div class="header-title"><h2>Resumo de Códigos</h2></div>
    </div>
  </header>

  <div class="container-principal">
    <div class="tabela-container">
      <table id="tabelaFogao65" class="table table-bordered table-striped">
        <thead><tr><th colspan="2">Fogões 6/5Q</th></tr><tr><th>CÓDIGO</th><th>TOTAL</th></tr></thead>
        <tbody></tbody>
        <tfoot><tr><td colspan="2">Total de Itens (6/5Q): <span id="totalFogao65">0</span></td></tr></tfoot>
      </table>
    </div>
    <div class="tabela-container">
      <table id="tabelaFogao4" class="table table-bordered table-striped">
        <thead><tr><th colspan="2">Fogões 4Q</th></tr><tr><th>CÓDIGO</th><th>TOTAL</th></tr></thead>
        <tbody></tbody>
        <tfoot><tr><td colspan="2">Total de Itens (4Q): <span id="totalFogao4">0</span></td></tr></tfoot>
      </table>
    </div>
  </div>

  <div id="totalGeralContainer">
    <h3>Total Geral de Todos os Itens: <strong id="totalGeral">0</strong></h3>
  </div>

  <div class="container-botoes">
    <input type="file" id="inputCSV" accept=".csv, .xlsx, .xls" />
    <button id="btnCarregar" class="btn btn-primary">Carregar Dados</button>
    <button id="btnAdicionar" class="btn btn-success">Inserir Mais Dados</button>
    <button id="btnExcluir" class="btn btn-danger">Excluir Dados</button>
  </div>

  <div class="modal fade" id="modalAvisoCarregamento" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-warning text-dark">
          <h5 class="modal-title">Atenção</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p id="aviso-carregamento-texto">Dados iniciais já foram inseridos!</p>
          <p class="text-center">Para incluir mais dados, selecione o botão "Inserir mais dados".</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="modalConfirmarExclusao" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title">Confirmar Exclusão</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p>Você tem certeza que deseja excluir todos os dados salvos? Esta ação não pode ser desfeita.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-danger" id="btnConfirmarExclusaoFinal">Sim, Excluir</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // NENHUMA MUDANÇA NO JAVASCRIPT
    const LOCAL_STORAGE_KEY = 'resumoDeCodigosDados_v2';
    let dadosAgregados = new Map();
    let limparDadosAntesDeCarregar = true;
    let dadosIniciaisCarregados = false;
    const inputArquivo = document.getElementById('inputCSV');
    const btnCarregar = document.getElementById('btnCarregar');
    const btnAdicionar = document.getElementById('btnAdicionar');
    const btnExcluir = document.getElementById('btnExcluir');
    const btnConfirmarExclusaoFinal = document.getElementById('btnConfirmarExclusaoFinal');
    const modalAviso = new bootstrap.Modal(document.getElementById('modalAvisoCarregamento'));
    const modalExclusao = new bootstrap.Modal(document.getElementById('modalConfirmarExclusao'));
    const corpoTabela65 = document.querySelector('#tabelaFogao65 tbody');
    const spanTotal65 = document.getElementById('totalFogao65');
    const corpoTabela4 = document.querySelector('#tabelaFogao4 tbody');
    const spanTotal4 = document.getElementById('totalFogao4');
    const spanTotalGeral = document.getElementById('totalGeral');
    btnCarregar.addEventListener('click', () => {
      if (dadosIniciaisCarregados) {
        modalAviso.show();
      } else {
        limparDadosAntesDeCarregar = true;
        inputArquivo.click();
      }
    });
    btnAdicionar.addEventListener('click', () => {
      limparDadosAntesDeCarregar = false;
      inputArquivo.click();
    });
    btnExcluir.addEventListener('click', () => {
      modalExclusao.show();
    });
    btnConfirmarExclusaoFinal.addEventListener('click', () => {
        dadosAgregados.clear();
        localStorage.removeItem(LOCAL_STORAGE_KEY);
        dadosIniciaisCarregados = false;
        renderizarTabelas();
        modalExclusao.hide();
    });
    inputArquivo.addEventListener('change', (evento) => { 
        const arquivo = evento.target.files[0];
        if (!arquivo) return;
        const nomeArquivo = arquivo.name.toLowerCase();
        const leitor = new FileReader();
        if (nomeArquivo.endsWith('.csv')) {
            leitor.onload = (e) => processarArquivoCSV(e.target.result);
            leitor.readAsText(arquivo);
        } else if (nomeArquivo.endsWith('.xlsx') || nomeArquivo.endsWith('.xls')) {
            leitor.onload = (e) => processarArquivoExcel(e.target.result);
            leitor.readAsArrayBuffer(arquivo);
        } else {
            alert('Formato de arquivo não suportado. Por favor, use .csv, .xlsx ou .xls');
        }
        inputArquivo.value = '';
    });
    function aplicarLogicaDeNegocio(linhas) {
      if (limparDadosAntesDeCarregar) {
        dadosAgregados.clear();
      }
      let codigoAtual = null, descricaoAtual = '';
      for (const colunas of linhas) {
        if (!Array.isArray(colunas)) continue;
        if (colunas.some(cell => typeof cell === 'string' && cell.includes("RELATÓRIO EXPEDIÇÃO"))) break;
        const possivelCodigo = colunas[0] ? String(colunas[0]).trim() : '';
        if (possivelCodigo && !isNaN(possivelCodigo)) {
          codigoAtual = possivelCodigo;
          descricaoAtual = colunas[1] ? String(colunas[1]).trim() : '';
        }
        const campoTotal = colunas[1] ? String(colunas[1]).trim() : '';
        if (campoTotal === 'TOTAL' && codigoAtual) {
          const valorTotal = colunas[9] ? parseInt(String(colunas[9]).trim(), 10) : 0;
          const tipoProduto = getTipoProduto(descricaoAtual);
          const itemExistente = dadosAgregados.get(codigoAtual) || { total: 0, tipo: tipoProduto };
          dadosAgregados.set(codigoAtual, {
            total: itemExistente.total + valorTotal,
            tipo: tipoProduto
          });
          codigoAtual = null;
          descricaoAtual = '';
        }
      }
      if(dadosAgregados.size > 0) {
        dadosIniciaisCarregados = true;
      }
      salvarDados();
      renderizarTabelas();
    }
    function carregarDados() {
      const dadosSalvos = localStorage.getItem(LOCAL_STORAGE_KEY);
      if (dadosSalvos) {
        const dadosArray = JSON.parse(dadosSalvos);
        dadosAgregados = new Map(dadosArray);
        if(dadosAgregados.size > 0) {
            dadosIniciaisCarregados = true;
        }
        renderizarTabelas();
      }
    }
    function processarArquivoCSV(textoCsv) { const separador = ';'; const linhas = textoCsv.split('\n'); const dados = linhas.map(linha => linha.split(separador)); aplicarLogicaDeNegocio(dados); }
    function processarArquivoExcel(arrayBuffer) { const data = new Uint8Array(arrayBuffer); const workbook = XLSX.read(data, {type: 'array'}); const nomePlanilha = workbook.SheetNames[0]; const planilha = workbook.Sheets[nomePlanilha]; const dados = XLSX.utils.sheet_to_json(planilha, {header: 1}); aplicarLogicaDeNegocio(dados); }
    function getTipoProduto(descricao) { const match = descricao.match(/\b(\d{4})\b/); if (match) { const primeiroDigito = match[1][0]; if (['5', '6'].includes(primeiroDigito)) return '65Q'; if (primeiroDigito === '4') return '4Q'; } return 'outro'; }
    function salvarDados() { const dadosArray = [...dadosAgregados.entries()]; localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(dadosArray)); }
    function renderizarTabelas() { corpoTabela65.innerHTML = ''; corpoTabela4.innerHTML = ''; let total65 = 0, total4 = 0; const dadosOrdenados = new Map([...dadosAgregados.entries()].sort()); dadosOrdenados.forEach((item, codigo) => { const novaLinha = document.createElement('tr'); novaLinha.innerHTML = `<td>0${codigo}</td><td>${item.total}</td>`; if (item.tipo === '65Q') { corpoTabela65.appendChild(novaLinha); total65 += item.total; } else if (item.tipo === '4Q') { corpoTabela4.appendChild(novaLinha); total4 += item.total; } }); spanTotal65.textContent = total65; spanTotal4.textContent = total4; spanTotalGeral.textContent = total65 + total4; }
    carregarDados();
  </script>
</body>
</html>